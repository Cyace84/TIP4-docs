<!-- # TIP4_3 (NFT indexing) Deployment

<div class="deployToken">

The indexing helps us to find the the users owned nfts faster and its purpose is to have the ability of fetching the and finding the nft contracts of a user even when the off-chain services are down.

TIP4_3Index contains two additional contracts besides its related collection and nft contracts.
These contracts are as follows:

- [TIP4_3Collection](https://github.com/broxus/tip4/blob/master/contracts/TIP4_3/TIP4_3Collection.tsol)
- [TIP4_3nft](https://github.com/broxus/tip4/blob/master/contracts/TIP4_3/TIP4_3Nft.tsol)
- [Index](https://github.com/broxus/tip4/blob/master/contracts/TIP4_3/Index.tsol)
- [IndexBasis](https://github.com/broxus/tip4/blob/master/contracts/TIP4_3/IndexBasis.tsol)

## Step 1: Prepare the Contracts

### Nft Contract

The base Nft contract will deploy two new `Index` contract with two different salts whenever its deployed, its manager gets changed or when its transferred, and accordingly will delete the these `Index` contracts whenever its burned, before its manager gets changed or gets transferred to another account.

So we will be adding the following functionalities to the base nft contract:

- deploying index in its constructor
- deploying the index in after transferring and changing the manager
- destructing the index when its burned
<details>
<summary> show code</summary>

````solidity

pragma ever-solidity >= 0.61.2;

pragma AbiHeader expire;
pragma AbiHeader time;
pragma AbiHeader pubkey;


import '@broxus/tip4/contracts/TIP4_2/TIP4_2Nft.tsol';
import '@broxus/tip4/contracts/TIP4_royalty/TIP4_royaltyNft.tsol';
import '@broxus/tip4/contracts/TIP4_royalty/structures/IRoyaltyStructure.tsol';


contract Nft is TIP4_2Nft, TIP4_royaltyNft {

    constructor(
        address owner,
        address sendGasTo,
        uint128 remainOnNft,
        string json,
        Royalty royalty
    ) TIP4_1Nft(
        owner,
        sendGasTo,
        remainOnNft
    )  TIP4_2Nft(
        json
    ) TIP4_royaltyNft(
        royalty
    ) public {
        tvm.accept();
    }

}
````

</details>


### Collection Contract

Import the `IRoyaltyStructure` and add the royalty when minting an nft.

<details>
<summary> show code</summary>

````solidity
pragma ever-solidity >= 0.61.2;

pragma AbiHeader expire;
pragma AbiHeader time;
pragma AbiHeader pubkey;


import '@broxus/tip4/contracts/access/OwnableExternal.tsol';
import '@broxus/tip4/contracts/TIP4_2/TIP4_2Collection.tsol';
import '@broxus/tip4/contracts/TIP4_royalty/structures/IRoyaltyStructure.tsol';
import './Nft.tsol';

contract Collection is TIP4_2Collection, OwnableExternal, IRoyaltyStructure {

    uint32 static _randomNonce;

    /**
    * Errors
    **/

    uint8 constant sender_is_not_owner = 100;
    uint8 constant value_is_less_than_required = 101;

    /// _remainOnNft - the number of crystals that will remain after the entire mint
    /// process is completed on the Nft contract
    uint128 _remainOnNft = 0.3 ever;

    constructor(
        TvmCell codeNft,
        uint256 ownerPubkey,
        string json
    ) OwnableExternal (
        ownerPubkey
    ) TIP4_1Collection (
        codeNft
    ) TIP4_2Collection (
        json
    ) public {
        tvm.accept();
    }

    function mintNft(string json, Royalty royalty) external virtual {
        require(msg.value > _remainOnNft + 0.1 ever, value_is_less_than_required);
        tvm.rawReserve(0, 4);

        uint256 id = uint256(_totalSupply);
        _totalSupply++;
        TvmCell codeNft = _buildNftCode(address(this));
        TvmCell stateNft = _buildNftState(codeNft, id);
        address nftAddr = new Nft{
            stateInit: stateNft,
            value: 0,
            flag: 128
        }(
            msg.sender,
            msg.sender,
            _remainOnNft,
            json,
            royalty
        );

        emit NftCreated(
            id,
            nftAddr,
            msg.sender,
            msg.sender,
            msg.sender
        );

    }

    function setRemainOnNft(uint128 remainOnNft) external virtual {
        require(TIP4_1Collection._isOwner(), sender_is_not_owner);
        _remainOnNft = remainOnNft;
    }

    function _isOwner() internal override onlyOwner returns(bool){
        return true;
    }

    function _buildNftState(
        TvmCell code,
        uint256 id
    ) internal virtual override(TIP4_2Collection) pure returns (TvmCell) {
        return tvm.buildStateInit({
            contr: Nft,
            varInit: {_id: id},
            code: code
        });
    }

}
````

</details>

### Build the Contracts Artifacts

run the command below into your terminal to build the written contracts artifacts:

````shell

npx locklift build

````

### Store Contracts Code and tvc

In order to deploy a contract using the `everscale-inpage-provider` tool we need the target contracts code and tvc.

Copy the build folder generated by the mentioned commend into the scripts folder of your project that using the `everscale-inpage-provider`.

## Step 2: Write Deployment Script

<span  :class="LLdis"  >

We can apply the changes mentioned in the code sample below into our [previously written script](./2.md#step-2-write-deployment-script) on deploying the `TIP4_2` contracts and use it next to the `locklift` tool un order deploy the `TIP4_Royalty` contracts.

::: info
Before we start to write our scripts we need to make sure that there is a file named `03-deploy-tip4-royalty.ts` in the `script` folder in the project root.
:::

</span>

<span :class="EIPdis"  >

The code sample below is utilized to deploy the mentioned contract using `everscale-inpage-provider` tool.

Edit the script on deploying `TIP4_2` contracts from the [previous part](./2.md#step-2-write-deployment-script) based on the changes of following scripts on deploying the nft and collection contracts of `TIP4_Royalty`.

::: info
The code sample for deploying the collection contract of this part using `everscale-inpage-provider` will stay `untouched`.
:::

</span>

<div @click="codeBlockSwitchHandler" >

::: code-group

````typescript [locklift]

// Defining a new interface to pass to the royalty information
interface IRoyaltyStructure {
  numerator: string | number;
  denominator: string | number;
  receiver: Address;
}

// Preparing the royalty info
const royalty: IRoyaltyStructure = {
  numerator: 1,
  denominator: 10,
  receiver: account.address,
};

// adding the prepared params as the input of the mint function
await collectionContract.methods
    .mintNft({ json: nftJsonMetadata, royalty: royalty }) // added royalty
    .send({ from: account.address, amount: locklift.utils.toNano(2) });

// Replace the line below with its according line from previous script
console.log(await nftContract.methods.royaltyInfo({ answerId: 0, salePrice: 100_000_000 }).call()); // 100$

````

````typescript [everscale-inpage-provider(nft)]

interface IRoyaltyStructure {
  numerator: string | number;
  denominator: string | number;
  receiver: Address;
}
    const mintRes: Transaction = await collectionContract.methods
      .mintNft({ json: jsonObj, royalty: royalty })
      .send({
        from: providerAddress,
        amount: String(2 * 10 ** 9),
        bounce: true,
      });
````

:::

</div>


<div class="action">

## Step 3: Deploy the NFT

<div :class="llAction">

Use this command to deploy TIP-3 tokens:

```shell
npx locklift run -s ./scripts/01-deploy-tip4-1.ts -n local
```
<ImgContainer src= '/typicalRoyalty.png' width="100%" altText="deployTip3Output" />

Congratulations, you have successfully deployed an NFT contract with royalty support using the `TIP4_1` standard ðŸŽ‰

</div>

<div :class="eipAction" >

<div :class="eipActionNft">

### Deploy TIP4_1 Collection


<label class="container collectionMetaCheck"> Use default metadata
<input class="checkboxInput" ref="actionCollectionMetaDefault" type="checkbox" @click="defaultMetaHandler" checked="true">
<span class="checkmark"></span>
</label>

<textarea style="resize:none;" ref="actionCollectionMeta" :class="collMeta" type="text" placeholder="collection json metadata"></textarea>

<button @click="deployCollection" class="deployTokenBut" >deploy collection</button>

<p id="output-p" :class="EIPdis"><loading :text="loadingText"/></p>

</div>

<div :class="eipActionNft">

### Mint TIP4_1 Nft

<p class=actionInName style="margin-bottom: 0;">Collection Address</p>

<input ref="actionCollectionAddress" class="action Ain" type="text"/>


<label class="container nftMetaCheck"> Use default metadata
<input class="checkboxInput" ref="actionNftMetaDefault" type="checkbox" @click="defaultMetaHandler" checked="true">
<span class="checkmark"></span>
</label>

<textarea  ref="actionNftMeta" :class="nftMeta" type="text" placeholder="Nft json metadata"></textarea>

<p class=actionInName style="margin-bottom: 0;">Royalty Percentage</p>

<input ref="actionRoyaltyPercent" type="number" min="0" max="100" step="0.01" class="action Ain percent" />

<p class=actionInName style="margin-bottom: 0;">Royalty Receiver Address</p>

<input ref="actionRoyaltyReceiverAddress" class="action Ain" type="text"/>

<button @click="deployNft" class="deployTokenBut" >Mint Nft</button>

<p id="output-p" :class="EIPdis"><loading :text="loadingText2"/></p>

</div>

</div>

</div>

</div>

<script lang="ts" >
import { defineComponent, ref, onMounted } from "vue";
import {toast} from "/src/helpers/toast";
import ImgContainer from "../../../.vitepress/theme/components/shared/BKDImgContainer.vue"
import loading from "../../../.vitepress/theme/components/shared/BKDLoading.vue"
import {deployTip4_RoyaltyCollection, deployTip4_RoyaltyNft} from "../../../scripts/typical/tip4_royalty";
import { IRoyaltyStructure } from "../../../scripts/types";

export default defineComponent({
  name: "deployToken",
      components :{
    ImgContainer,
    loading
  },
  data(){
    return{
        LLdis: "cbShow",
        EIPdis: "cbHide",
        llAction: "llAction cbShow",
        eipAction: "eipAction cbHide",
        eipActionNft: "eipAction cbHide",
        eipActionCollection: "eipAction cbHide",
        collMeta: "cbHide",
         nftMeta: "cbHide",
        loadingText: " ",
        loadingText2: " "
        }
  },
  setup() {

  async function defaultMetaHandler(e){
        if(e.target.checked){

        if(e.target.parentElement.className.includes("collectionMetaCheck"))
         {
            this.collMeta = "cbHide"
         } else if(e.target.parentElement.className.includes("nftMetaCheck"))
         {
            this.nftMeta = "cbHide"
         }
        }else{

        if(e.target.parentElement.className.includes("collectionMetaCheck"))
         {
            this.collMeta = "action Ain"
         } else if(e.target.parentElement.className.includes("nftMetaCheck"))
         {
            this.nftMeta = "action Ain"
         }
        }

    }
  async function deployCollection(){
        this.loadingText = ""
        if (
            !this.$refs.actionCollectionMetaDefault.checked &&
            this.$refs.actionCollectionMeta.value == ''

        ){
            toast("Collection metadata field is required !", 0)
            this.loadingText = "Failed"
            return
        }
        let deployTokenRes;
        if(this.$refs.actionCollectionMetaDefault.checked){
            deployTokenRes = await deployTip4_RoyaltyCollection()

        }else{
            deployTokenRes = await deployTip4_RoyaltyCollection(this.$refs.actionCollectionMeta.value)
        }
          // Rendering the output
          deployTokenRes = !deployTokenRes ? "Failed" :  deployTokenRes;
          this.loadingText = deployTokenRes;
  }

   async function deployNft(){
          this.loadingText2 = ""
        if (
            this.$refs.actionCollectionAddress.value == ''

        ){
            toast("collection address field is required !", 0)
            this.loadingText2 = "Failed"
            return
        }
        if (
            !this.$refs.actionNftMetaDefault.checked &&
            this.$refs.actionNftMeta.value == ''

        ){
            toast("Nft metadata field is required !", 0)
            this.loadingText2 = "Failed"
            return
        }
        if (
            isNaN(Number(this.$refs.actionRoyaltyPercent.value))
        ){
            toast("Royalty percentage field is required !", 0)
            this.loadingText2 = "Failed"
            return
        }
        if (
            this.$refs.actionRoyaltyReceiverAddress.value == ''

        ){
            toast("Royalty receiver address field is required !", 0)
            this.loadingText2 = "Failed"
            return
        }
        let deployTokenRes;
        const royalty: IRoyaltyStructure =
        {
            numerator: Number(this.$refs.actionRoyaltyPercent.value),
            denominator: 100,
            receiver: this.$refs.actionRoyaltyReceiverAddress.value
        }
        if(this.$refs.actionNftMetaDefault.checked){
            deployTokenRes = await deployTip4_RoyaltyNft(
                this.$refs.actionCollectionAddress.value,
                royalty
            )
        }else{
            deployTokenRes = await deployTip4_RoyaltyNft(
                this.$refs.actionCollectionAddress.value,
                this.$refs.actionNftMeta.value,
                royalty
            )
        }
        // Rendering the output
        deployTokenRes = !deployTokenRes ? "Failed" :  deployTokenRes;
        this.loadingText2 = deployTokenRes;
  }
  async function codeBlockSwitchHandler(e){
     if(e.target.innerHTML.includes("everscale-inpage-provider(collection)")){
        this.LLdis = "cbHide"
        this.EIPdis = "cbShow"
        this.llAction = "llAction cbHide"
        this.eipAction = "eipAction cbShow"
        this.eipActionNft = "eipAction cbHide"
        this.eipActionCollection = "eipAction cbShow"
     }else if(e.target.innerHTML.includes("everscale-inpage-provider(nft)")){
        this.LLdis = "cbHide"
        this.EIPdis = "cbShow"
        this.llAction = "llAction cbHide"
        this.eipAction = "eipAction cbShow"
        this.eipActionCollection = "eipAction cbHide"
        this.eipActionNft = "eipAction cbShow"
     }else if(e.target.innerHTML.includes("locklift")){
        this.EIPdis = "cbHide"
        this.LLdis = "cbShow"
        this.llAction = "llAction cbShow"
        this.eipAction = "eipAction cbHide"

     }
  }
return {
        defaultMetaHandler,
        deployNft,
        deployCollection,
        codeBlockSwitchHandler
    };
  },
});

</script>


<style>

textarea{
 width:100%;
 height: 400px;
}

.action{
    display:inline-block;
}

.actionInName{
    font-size: .9rem;
}

.deployTokenBut, .Ain, details
{
  background-color: var(--vp-c-bg-mute);
  transition: background-color 0.1s;
  border: 1px solid var(--vp-c-divider);
  border-radius: 8px;
  font-weight: 600;
  cursor : pointer;
}

details{
    padding : 0 10px 0 10px;
}
.Ain{
    padding-left : 10px;
    margin : 0;
}
.deployTokenBut{
    cursor:pointer;
    padding: 5px 12px;
    display: flex;
    transition: all ease .3s;
}

.deployTokenBut:hover{
      border: 1px solid var(--light-color-ts-class);
}

#output-p{
    /* height: 30px; */
    padding: 2px 10px;
    border-radius: 8px;
    border: 1px solid var(--vp-c-divider);
    }

.cbShow{
    display: block;
}
.cbHide{
    display: none;
}

.eipAction{
    font-weight: 600;
}

* {box-sizing: border-box;}

.container {
  display: flex;
  position: relative;
  margin-bottom: 12px;
  font-size: .9rem;
}

.container .checkboxInput {
  position: absolute;
  opacity: 0;
  height: 0;
  width: 0;

}

.checkmark {
  cursor: pointer;
  position: relative;
  top: 0;
  left: 0;
  height: 25px;
  width: 25px;
  background-color: var(--vp-c-bg-mute);
  border: 1px solid var(--vp-c-divider);
  border-radius : 8px;
  margin-left: 10px;
}

.container input:checked ~ .checkmark {
  background-color: var(--light-color-ts-class);
}

.checkmark:after {
  content: "";
  position: absolute;
  display: none;
}

.container input:checked ~ .checkmark:after {
  display: block;
}

.container .checkmark:after {
  left: 9px;
  top: 5px;
  width: 5px;
  height: 10px;
  border: solid white;
  border-width: 0 3px 3px 0;
  -webkit-transform: rotate(45deg);
  -ms-transform: rotate(45deg);
  transform: rotate(45deg);
}

</style> -->